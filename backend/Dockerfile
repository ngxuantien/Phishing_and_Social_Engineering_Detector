# 1. D√πng b·∫£n python-slim (r·∫•t nh·∫π, gi·∫£m b·ªõt v√†i trƒÉm MB h·ªá ƒëi·ªÅu h√†nh th·ª´a)
FROM python:3.10-slim

# 2. Thi·∫øt l·∫≠p User (B·∫Øt bu·ªôc cho HF Spaces)
RUN useradd -m -u 1000 user
USER user
ENV HOME=/home/user \
    PATH=/home/user/.local/bin:$PATH

WORKDIR $HOME/app

# 3. C√†i ƒë·∫∑t c√°c g√≥i h·ªá th·ªëng t·ªëi thi·ªÉu (n·∫øu c·∫ßn cho transformers)
# Chuy·ªÉn v·ªÅ root t·∫°m th·ªùi ƒë·ªÉ c√†i
USER root
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*
USER user

# 4. üî• B∆Ø·ªöC QUAN TR·ªåNG NH·∫§T: C√†i PyTorch b·∫£n CPU (Si√™u nh·∫π)
# T√°ch ri√™ng b∆∞·ªõc n√†y ra ƒë·ªÉ Docker cache l·∫°i, kh√¥ng ph·∫£i t·∫£i l·∫°i m·ªói l·∫ßn s·ª≠a code
RUN pip install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cpu

# 5. Copy requirements v√† c√†i c√°c th∆∞ vi·ªán c√≤n l·∫°i
COPY --chown=user ./requirements.txt requirements.txt
RUN pip install --no-cache-dir --upgrade -r requirements.txt

# 6. Copy to√†n b·ªô code
COPY --chown=user . .

# 7. M·ªü port 7860
EXPOSE 7860

# 8. Ch·∫°y server
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "7860"]